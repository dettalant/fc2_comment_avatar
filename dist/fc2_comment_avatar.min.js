/*!
 * @file fc2_comment_avatar.js
 * See {@link https://github.com/dettalant/fc2_comment_avatar| dettalant/fc2_comment_avatar}
 *
 * @author dettalant
 * @version v0.2.0
 * @license MIT License
 */
var fc2_comment_avatar=function(a){"use strict";function s(a){this.message=a,this.name="NavManagerError"}var c=null===window.ontouchend?"touchend":"click",h="__default__",u="__admin__",d="avatarCode";s.prototype.toString=function(){return this.name+": "+this.message};function t(a){if(this.emailInputId="mail",this.isUseDataSrc=!1,this.isUseCustomDefaultImg=!1,this.isUseAdminAvatar=!0,void 0===a)throw new s("初期化に必要な情報が入力されませんでした。CommentAvatarクラスの初期化引数には必要情報が格納されたobjectを入れてください");var t=document.getElementsByClassName(a.avatarClassName);if(0===t.length)throw new s("アバター要素の取得に失敗しました");var e=document.getElementById(a.avatarSelectButtonId);if(null===e)throw new s("アバター選択ボタン要素の取得に失敗しました");var r=document.getElementById(a.emailInputId);if(null===r||!(r instanceof HTMLInputElement))throw new s("メールアドレス入力欄の取得に失敗しました");this.avatarContainers=t,this.avatarClassName=a.avatarClassName,this.avatarImgClassName=a.avatarImgClassName,this.avatarsList=this.avatarsListFormat(a.avatarsList),this.avatarSelectButton=e,this.avatarSelectButtonId=a.avatarSelectButtonId,this.emailInputId=a.emailInputId,this.emailInput=r,a.isUseDataSrc&&(this.isUseDataSrc=a.isUseDataSrc),!1===a.isUseAdminAvatar&&(this.isUseAdminAvatar=a.isUseAdminAvatar),this.avatarSelectButtonImg=this.avatarSelectButtonInit(this.avatarSelectButton);var i=this.scanAvatarCodes();this.avatarsImgOverWrite(i)}var e={defaultAvatarData:{configurable:!0},userAvatarsData:{configurable:!0}};return t.prototype.avatarsListFormat=function(a){var t=h;return void 0===a[t]?a[t]="https://static.fc2.com/image/sh_design/no_image/no_image_300x300.png":this.isUseCustomDefaultImg=!0,void 0===a.__admin__&&(this.isUseAdminAvatar=!1),a},t.prototype.avatarSelectButtonInit=function(a){function n(a,t){a.addEventListener(c,function(a){return t(a)})}var v=this,t=[],e=document.createElement("img");e.className="comment_avatar_img lazyload";var r=this.defaultAvatarData,i=localStorage.getItem(d);if(null!==i&&""!==i){var s=this.avatarCodeParse(i);this.isMatchAvatarName(s)&&(this.emailInput.value=i,this.avatarDataOverWrite(r,e,s,this.getAvatarSrcUrl(s)))}r.imgEl=e,this.avatarImgOverWrite(r);var o=document.createElement("div");o.className="comment_form_avatar_img_wrapper",o.appendChild(e),t.push(o);var m=a.dataset.buttonText;if(void 0!==m){var l=document.createElement("span");l.className="comment_form_avatar_button_text",l.innerText=m,t.push(l)}var u=document.createElement("div");return u.className="comment_form_avatar_select_container",function(i){for(var s=v.userAvatarsData,a=s.length,t=function(a){var t=s[a],e=document.createElement("button");e.type="button",e.className="comment_form_avatar_select_button",n(e,function(){var a="";t.name!==h&&(a="[["+t.name+"]]"),v.emailInput.value=a,localStorage.setItem(d,a),v.avatarSelectButtonImg.src=t.url});var r=document.createElement("img");r.className="comment_avatar_img lazyload",t.imgEl=r,v.avatarImgOverWrite(t),e.appendChild(t.imgEl),i.appendChild(e)},e=0;e<a;e++)t(e)}(u),t.push(u),function(a,t){for(var e=t.length,r=0;r<e;r++)a.appendChild(t[r])}(a,t),n(a,function(){u.classList.toggle("is_visible")}),e},t.prototype.avatarDataOverWrite=function(a,t,e,r){return t instanceof HTMLImageElement&&(a.imgEl=t),void 0!==e&&(a.name=e),void 0!==r&&(a.url=r),a},t.prototype.scanAvatarCodes=function(){for(var a=this.avatarContainers.length,t=[],e=0;e<a;e++){var r=this.avatarContainers[e],i=r.dataset.avatarCode,s=r.dataset.isAdminAvatar;if(this.isUseAdminAvatar&&s){var n=u,v=this.avatarDataOverWrite(this.defaultAvatarData,r.querySelector("."+this.avatarImgClassName),n,this.getAvatarSrcUrl(n));t.push(v)}else if(void 0===i||-1===i.indexOf("[[")&&-1===i.indexOf("]]")){if(this.isUseCustomDefaultImg){var o=this.avatarDataOverWrite(this.defaultAvatarData,r.querySelector("."+this.avatarImgClassName));t.push(o)}}else{var m=this.avatarCodeParse(i);if(""!==m&&this.isMatchAvatarName(m)){var l=this.avatarDataOverWrite(this.defaultAvatarData,r.querySelector("."+this.avatarImgClassName),m,this.getAvatarSrcUrl(m));t.push(l)}}}return t},t.prototype.avatarCodeParse=function(a){var t=/\[\[[\s　]*?([^\[\]\s　]+?)[\s　]*?\]\]/.exec(a);return null===t||t.length<2?"":t[1]},t.prototype.isMatchAvatarName=function(a){return!!this.avatarsList[a]},e.defaultAvatarData.get=function(){var a=h;return{imgEl:null,name:a,url:this.getAvatarSrcUrl(a)}},e.userAvatarsData.get=function(){var a=[],t=Object.keys(this.avatarsList),e=t.length;a.push(this.defaultAvatarData);for(var r=0;r<e;r++){var i=t[r];if(i!==h&&i!==u){var s={imgEl:null,name:i,url:this.getAvatarSrcUrl(i)};a.push(s)}}return a},t.prototype.getAvatarSrcUrl=function(a){var t=this.avatarsList[a];return void 0===t?"":t},t.prototype.avatarImgOverWrite=function(a){null!==a.imgEl&&(this.isUseDataSrc?a.imgEl.dataset.src=a.url:a.imgEl.src=a.url)},t.prototype.avatarsImgOverWrite=function(a){for(var t=a.length,e=0;e<t;e++)this.avatarImgOverWrite(a[e])},Object.defineProperties(t.prototype,e),a.CommentAvatar=t,a}({});
