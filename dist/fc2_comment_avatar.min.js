/*!
 *   fc2_comment_avatar.js
 * See {@link https://github.com/dettalant/fc2_comment_avatar}
 *
 * @author dettalant
 * @version v0.2.4
 * @license MIT License
 */
var fc2_comment_avatar=function(t){"use strict";function c(t){this.message=t,this.name="CommentAvatarError"}var h,a;c.prototype.toString=function(){return this.name+": "+this.message},(a=h=h||{}).DEVICE_CLICK_EVENT_TYPE=null===window.ontouchend?"touchend":"click",a.DEFAULT_AVATAR_KEY="__default__",a.ADMIN_AVATAR_KEY="__admin__",a.SECRET_AVATAR_KEY="__secret__",a.LOCALSTORAGE_AVATAR_CODE_KEY="avatarCode",a.STATE_VISIBLE="is_visible";function e(t){if(void 0===t)throw new c("初期化に必要な情報が入力されませんでした。CommentAvatarクラスの初期化引数には必要情報が格納されたobjectを入れてください");if(void 0===t.avatarsList)throw new c("初期化引数にavatarsList要素がありません！");var a=this.defaultCommentAvatarOptions;void 0!==t.options&&Object.assign(a,t.options);var e=this.defaultCommentAvatarTargetSrc;void 0!==t.targetsSrc&&Object.assign(e,t.targetsSrc),this.caArgs={avatarsList:{},options:a,targetsSrc:e};var r={avatars:null,avatarSelectButton:null,avatarSelectButtonImg:null,emailInput:null},s=document.getElementsByClassName(this.caArgs.targetsSrc.avatarClassName);0===s.length?(this.caArgs.options.isCommentAvatarOverwrite=!1,this.printDebugMessage("アバター要素の取得失敗。コメント欄アバター書き換え機能無効化",!0)):r.avatars=s;var i=document.getElementById(this.caArgs.targetsSrc.avatarSelectButtonId);if(null===i?(this.caArgs.options.isAvatarSelect=!1,this.printDebugMessage("アバター選択ボタン要素の取得失敗。コメント入力欄アバター選択機能無効化")):r.avatarSelectButton=i,this.caArgs.options.isAvatarSelect){var n=document.getElementById(this.caArgs.targetsSrc.emailInputId);null!==n&&n instanceof HTMLInputElement?r.emailInput=n:(this.caArgs.options.isAvatarSelect=!1,this.printDebugMessage("email入力欄要素の取得失敗。コメント入力欄アバター選択機能無効化"))}if(this.caArgs.avatarsList=this.avatarListFormat(t.avatarsList),this.caArgs.targets=r,this.caArgs.options.isCommentAvatarOverwrite){this.printDebugMessage("コメントアバター書き換え処理実行",!1);var o=this.scanAvatarCodes();this.avatarImgsOverwrite(o)}this.caArgs.options.isAvatarSelect&&null!==this.caArgs.targets.avatarSelectButton&&(this.printDebugMessage("アバター選択ボタン設置処理実行",!0),this.avatarSelectButtonInit(this.caArgs.targets.avatarSelectButton))}var r={defaultAvatarData:{configurable:!0},userAvatarsData:{configurable:!0},defaultCommentAvatarTargetSrc:{configurable:!0},defaultCommentAvatarOptions:{configurable:!0}};return e.prototype.avatarSelectButtonInit=function(t){var n=this;if(void 0===this.caArgs.targets||null===this.caArgs.targets.emailInput)return null;function a(t){var a=!1;if(void 0===n.caArgs.targets||null===n.caArgs.targets.emailInput)return a;var e=n.avatarCodeParse(t);return n.isMatchAvatarName(e)&&(n.caArgs.targets.emailInput.value=t,a=!0,n.printDebugMessage(e+"アバターを初期アバターとして使用",!1),n.avatarDataOverWrite(s,r,e,n.getAvatarSrcUrl(e))),a}var e=[],r=document.createElement("img");r.className=this.caArgs.targetsSrc.avatarClassName;var s=this.defaultAvatarData,i=t.dataset.initialAvatar,o=!1;if(void 0!==i&&""!==i&&(o=a(i)),!o){var c=localStorage.getItem(h.LOCALSTORAGE_AVATAR_CODE_KEY);null!==c&&""!==c&&a(c)}s.imgEl=r,this.avatarImgOverwrite(s),this.caArgs.targets.avatarSelectButtonImg=r;var v=document.createElement("div");v.className="comment_form_avatar_img_wrapper",v.appendChild(r),e.push(v);var l=t.dataset.buttonText;if(void 0!==l){var m=document.createElement("span");m.className="comment_form_avatar_button_text",m.innerText=l,e.push(m)}var u=document.createElement("div");return u.className="comment_form_avatar_select_container",function(s){for(var i=n.userAvatarsData,t=i.length,a=function(t){var a=i[t],e=document.createElement("button");e.type="button",e.className="comment_form_avatar_select_button",e.addEventListener(h.DEVICE_CLICK_EVENT_TYPE,function(){if(void 0!==n.caArgs.targets&&null!==n.caArgs.targets.emailInput&&null!==n.caArgs.targets.avatarSelectButtonImg){var t="";a.name!==h.DEFAULT_AVATAR_KEY&&(t="[["+a.name+"]]"),n.caArgs.targets.emailInput.value=t,localStorage.setItem(h.LOCALSTORAGE_AVATAR_CODE_KEY,t),n.caArgs.targets.avatarSelectButtonImg.src=a.url}else n.printDebugMessage("個別アバター選択ボタンクリック処理に必要要素が不足。処理を中止",!0)});var r=document.createElement("img");r.className="comment_avatar_img lazyload",a.imgEl=r,n.avatarImgOverwrite(a),e.appendChild(a.imgEl),s.appendChild(e)},e=0;e<t;e++)a(e)}(u),e.push(u),function(t,a){for(var e=a.length,r=0;r<e;r++)t.appendChild(a[r])}(t,e),t.addEventListener(h.DEVICE_CLICK_EVENT_TYPE,function(){u.classList.toggle(h.STATE_VISIBLE)}),document.addEventListener(h.DEVICE_CLICK_EVENT_TYPE,function(t){if(-1!==u.className.indexOf(h.STATE_VISIBLE)){var s=function(t,a){var e=t.tagName.toUpperCase(),r=a.toUpperCase();return e===r?t:e!==r&&null!==t.parentElement?s(t.parentElement,r):t};if(t.target instanceof Element){var a=s(t.target,"button");-1===a.className.indexOf("comment_form_avatar_select_button")&&-1===a.className.indexOf("comment_form_avatar_button")&&u.classList.remove(h.STATE_VISIBLE)}}}),r},e.prototype.scanAvatarCodes=function(){if(void 0===this.caArgs.targets||null===this.caArgs.targets.avatars)return[];for(var t=this.caArgs.targets.avatars.length,a=this.caArgs.targetsSrc.avatarImgClassName,e=[],r=0;r<t;r++){var s=this.caArgs.targets.avatars[r];if(s instanceof HTMLElement){var i=s.dataset.avatarCode,n=s.dataset.isAdminAvatar,o=void 0!==s.dataset.commentSubject?s.dataset.commentSubject:"";if(this.caArgs.options.isUseAdminAvatar&&n){var c=h.ADMIN_AVATAR_KEY,v=this.avatarDataOverWrite(this.defaultAvatarData,s.querySelector("."+a),c,this.getAvatarSrcUrl(c));e.push(v)}else if(this.caArgs.options.isUseSecretAvatar&&-1!==o.indexOf("管理人のみ閲覧できます")){var l=h.SECRET_AVATAR_KEY,m=this.avatarDataOverWrite(this.defaultAvatarData,s.querySelector("."+a),l,this.getAvatarSrcUrl(l));e.push(m)}else if(void 0===i||-1===i.indexOf("[[")&&-1===i.indexOf("]]")){if(this.caArgs.options.isUseCustomDefaultImg){var u=this.avatarDataOverWrite(this.defaultAvatarData,s.querySelector("."+a));e.push(u)}}else{var g=this.avatarCodeParse(i);if(""!==g&&this.isMatchAvatarName(g)){var A=this.avatarDataOverWrite(this.defaultAvatarData,s.querySelector("."+a),g,this.getAvatarSrcUrl(g));e.push(A)}}}}return e},e.prototype.avatarListFormat=function(t){return void 0===t[h.DEFAULT_AVATAR_KEY]?t[h.DEFAULT_AVATAR_KEY]="https://static.fc2.com/image/sh_design/no_image/no_image_300x300.png":void 0===this.caArgs.options.isUseCustomDefaultImg&&(this.caArgs.options.isUseCustomDefaultImg=!0),void 0===t[h.ADMIN_AVATAR_KEY]&&(this.caArgs.options.isUseAdminAvatar=!1),void 0===t[h.SECRET_AVATAR_KEY]&&(this.caArgs.options.isUseSecretAvatar=!1),t},e.prototype.avatarCodeParse=function(t){var a=/\[\[[\s　]*?([^\[\]\s　]+?)[\s　]*?\]\]/.exec(t);return null===a||a.length<2?"":a[1]},e.prototype.isMatchAvatarName=function(t){return!!this.caArgs.avatarsList[t]},e.prototype.avatarDataOverWrite=function(t,a,e,r){return a instanceof HTMLImageElement&&(t.imgEl=a),void 0!==e&&(t.name=e),void 0!==r&&(t.url=r),t},e.prototype.avatarImgOverwrite=function(t){null!==t.imgEl&&(this.caArgs.options.isUseLazysizes?(t.imgEl.dataset.src=t.url,t.imgEl.className=this.caArgs.targetsSrc.avatarImgClassName+" lazyload"):t.imgEl.src=t.url)},e.prototype.avatarImgsOverwrite=function(t){for(var a=t.length,e=0;e<a;e++)this.avatarImgOverwrite(t[e])},e.prototype.printDebugMessage=function(t,a){this.caArgs.options.isDebug&&(a?console.warn(t):console.log(t))},e.prototype.getAvatarSrcUrl=function(t){var a=this.caArgs.avatarsList[t];return void 0===a?"":a},r.defaultAvatarData.get=function(){var t=h.DEFAULT_AVATAR_KEY;return{imgEl:null,name:t,url:this.getAvatarSrcUrl(t)}},r.userAvatarsData.get=function(){var t=[],a=Object.keys(this.caArgs.avatarsList),e=a.length;t.push(this.defaultAvatarData);for(var r=0;r<e;r++){var s=a[r];if(s!==h.DEFAULT_AVATAR_KEY&&s!==h.ADMIN_AVATAR_KEY&&s!==h.SECRET_AVATAR_KEY){var i={imgEl:null,name:s,url:this.getAvatarSrcUrl(s)};t.push(i)}}return t},r.defaultCommentAvatarTargetSrc.get=function(){return{avatarClassName:"comment_avatar",avatarImgClassName:"comment_avatar_img",avatarSelectButtonId:"commentAvatarSelectButton",emailInputId:"commentFormMail"}},r.defaultCommentAvatarOptions.get=function(){return{isUseLazysizes:!1,isUseAdminAvatar:!0,isUseSecretAvatar:!0,isCommentAvatarOverwrite:!0,isAvatarSelect:!0,isDebug:!1}},Object.defineProperties(e.prototype,r),t.CommentAvatar=e,t}({});
