/*!
 *   fc2_comment_avatar.js
 * See {@link https://github.com/dettalant/fc2_comment_avatar}
 *
 * @author dettalant
 * @version v0.2.8
 * @license MIT License
 */
var fc2_comment_avatar=function(t){"use strict";function c(t){this.message=t,this.name="CommentAvatarError"}c.prototype.toString=function(){return this.name+": "+this.message};function a(t){if(void 0===t)throw new c("初期化に必要な情報が入力されませんでした。CommentAvatarクラスの初期化引数には必要情報が格納されたobjectを入れてください");if(void 0===t.avatarsList)throw new c("初期化引数にavatarsList要素がありません！");var a=this.defaultCommentAvatarOptions;void 0!==t.options&&Object.assign(a,t.options);var e=this.defaultCommentAvatarTargetSrc;void 0!==t.targetsSrc&&Object.assign(e,t.targetsSrc),this.caArgs={avatarsList:{},options:a,targetsSrc:e};var r={avatars:null,avatarSelectButton:null,avatarSelectButtonImg:null,emailInput:null},s=document.getElementsByClassName(this.caArgs.targetsSrc.avatarClassName);0===s.length?(this.caArgs.options.isCommentAvatarOverwrite=!1,this.printDebugMessage("アバター要素の取得失敗。コメント欄アバター書き換え機能無効化",!0)):r.avatars=s;var i=document.getElementById(this.caArgs.targetsSrc.avatarSelectButtonId);if(null===i?(this.caArgs.options.isAvatarSelect=!1,this.printDebugMessage("アバター選択ボタン要素の取得失敗。コメント入力欄アバター選択機能無効化")):r.avatarSelectButton=i,this.caArgs.options.isAvatarSelect){var n=document.getElementById(this.caArgs.targetsSrc.emailInputId);null!==n&&n instanceof HTMLInputElement?r.emailInput=n:(this.caArgs.options.isAvatarSelect=!1,this.printDebugMessage("email入力欄要素の取得失敗。コメント入力欄アバター選択機能無効化"))}if(this.caArgs.avatarsList=this.avatarListFormat(t.avatarsList),this.caArgs.targets=r,this.caArgs.options.isCommentAvatarOverwrite){this.printDebugMessage("コメントアバター書き換え処理実行",!1);var o=this.scanAvatarCodes();this.avatarImgsOverwrite(o)}this.caArgs.options.isAvatarSelect&&null!==this.caArgs.targets.avatarSelectButton&&(this.printDebugMessage("アバター選択ボタン設置処理実行",!0),this.avatarSelectButtonInit(this.caArgs.targets.avatarSelectButton))}var u="__default__",A="__admin__",d="__secret__",h="avatarCode",f="is_visible",e={defaultAvatarData:{configurable:!0},userAvatarsData:{configurable:!0},defaultCommentAvatarTargetSrc:{configurable:!0},defaultCommentAvatarOptions:{configurable:!0}};return a.prototype.avatarSelectButtonInit=function(t){var n=this;if(void 0===this.caArgs.targets||null===this.caArgs.targets.emailInput)return null;function a(t){var a=!1;if(void 0===n.caArgs.targets||null===n.caArgs.targets.emailInput)return a;var e=n.avatarCodeParse(t);return n.isMatchAvatarName(e)&&(n.caArgs.targets.emailInput.value=t,a=!0,n.printDebugMessage(e+"アバターを初期アバターとして使用",!1),n.avatarDataOverWrite(s,r,e,n.getAvatarSrcUrl(e))),a}var e=[],r=document.createElement("img");r.className=this.caArgs.targetsSrc.avatarClassName;var s=this.defaultAvatarData,i=t.dataset.initialAvatar,o=!1;if(void 0!==i&&""!==i&&(o=a(i)),!o){var c=localStorage.getItem(h);null!==c&&""!==c&&a(c)}s.imgEl=r,this.avatarImgOverwrite(s),this.caArgs.targets.avatarSelectButtonImg=r;var v=document.createElement("div");v.className="comment_form_avatar_img_wrapper",v.appendChild(r),e.push(v);var l=t.dataset.buttonText;if(void 0!==l){var m=document.createElement("span");m.className="comment_form_avatar_button_text",m.innerText=l,e.push(m)}var g=document.createElement("div");return g.className="comment_form_avatar_select_container",function(s){for(var i=n.userAvatarsData,t=i.length,a=function(t){var e=i[t],a=document.createElement("button");a.type="button",a.className="comment_form_avatar_select_button",a.addEventListener("click",function(t){if(void 0!==n.caArgs.targets&&null!==n.caArgs.targets.emailInput&&null!==n.caArgs.targets.avatarSelectButtonImg){t.preventDefault();var a="";e.name!==u&&(a="[["+e.name+"]]"),n.caArgs.targets.emailInput.value=a,localStorage.setItem(h,a),n.caArgs.targets.avatarSelectButtonImg.src=e.url,s.classList.remove(f)}else n.printDebugMessage("個別アバター選択ボタンクリック処理に必要要素が不足。処理を中止",!0)});var r=document.createElement("img");r.className="comment_avatar_img lazyload",e.imgEl=r,n.avatarImgOverwrite(e),a.appendChild(e.imgEl),s.appendChild(a)},e=0;e<t;e++)a(e)}(g),t.parentElement instanceof HTMLElement&&t.parentElement.insertBefore(g,t.nextSibling),function(t,a){for(var e=a.length,r=0;r<e;r++)t.appendChild(a[r])}(t,e),t.addEventListener("click",function(){g.classList.toggle(f)}),document.addEventListener("click",function(t){if(-1!==g.className.indexOf(f)){var s=function(t,a){var e=t.tagName.toUpperCase(),r=a.toUpperCase();return e===r?t:e!==r&&null!==t.parentElement?s(t.parentElement,r):t};if(t.target instanceof Element){var a=s(t.target,"button");-1===a.className.indexOf("comment_form_avatar_select_button")&&-1===a.className.indexOf("comment_form_avatar_button")&&g.classList.remove(f)}}}),r},a.prototype.scanAvatarCodes=function(){if(void 0===this.caArgs.targets||null===this.caArgs.targets.avatars)return[];for(var t=this.caArgs.targets.avatars.length,a=this.caArgs.targetsSrc.avatarImgClassName,e=[],r=0;r<t;r++){var s=this.caArgs.targets.avatars[r];if(s instanceof HTMLElement){var i=s.dataset.avatarCode,n=s.dataset.isAdminAvatar,o=void 0!==s.dataset.commentSubject?s.dataset.commentSubject:"";if(this.caArgs.options.isUseAdminAvatar&&n){var c=A,v=this.avatarDataOverWrite(this.defaultAvatarData,s.querySelector("."+a),c,this.getAvatarSrcUrl(c));e.push(v)}else if(this.caArgs.options.isUseSecretAvatar&&-1!==o.indexOf("管理人のみ閲覧できます")){var l=d,m=this.avatarDataOverWrite(this.defaultAvatarData,s.querySelector("."+a),l,this.getAvatarSrcUrl(l));e.push(m)}else{if(void 0!==i&&-1!==i.indexOf("[[")&&-1!==i.indexOf("]]")){var g=this.avatarCodeParse(i);if(""===g);else if(this.isMatchAvatarName(g)){var u=this.avatarDataOverWrite(this.defaultAvatarData,s.querySelector("."+a),g,this.getAvatarSrcUrl(g));e.push(u);continue}}if(this.caArgs.options.isUseCustomDefaultImg){var h=this.avatarDataOverWrite(this.defaultAvatarData,s.querySelector("."+a));e.push(h)}}}}return e},a.prototype.avatarListFormat=function(t){return void 0===t[u]?t[u]="https://static.fc2.com/image/sh_design/no_image/no_image_300x300.png":void 0===this.caArgs.options.isUseCustomDefaultImg&&(this.caArgs.options.isUseCustomDefaultImg=!0),void 0===t[A]&&(this.caArgs.options.isUseAdminAvatar=!1),void 0===t[d]&&(this.caArgs.options.isUseSecretAvatar=!1),t},a.prototype.avatarCodeParse=function(t){var a=/\[\[[\s　]*?([^\[\]\s　]+?)[\s　]*?\]\]/.exec(t);return null===a||a.length<2?"":a[1]},a.prototype.isMatchAvatarName=function(t){return!!this.caArgs.avatarsList[t]},a.prototype.avatarDataOverWrite=function(t,a,e,r){return a instanceof HTMLImageElement&&(t.imgEl=a),void 0!==e&&(t.name=e),void 0!==r&&(t.url=r),t},a.prototype.avatarImgOverwrite=function(t){null!==t.imgEl&&(this.caArgs.options.isUseLazysizes?(t.imgEl.dataset.src=t.url,t.imgEl.className=this.caArgs.targetsSrc.avatarImgClassName+" lazyload"):t.imgEl.src=t.url)},a.prototype.avatarImgsOverwrite=function(t){for(var a=t.length,e=0;e<a;e++)this.avatarImgOverwrite(t[e])},a.prototype.printDebugMessage=function(t,a){this.caArgs.options.isDebug&&(a?console.warn(t):console.log(t))},a.prototype.getAvatarSrcUrl=function(t){var a=this.caArgs.avatarsList[t];return void 0===a?"":a},e.defaultAvatarData.get=function(){var t=u;return{imgEl:null,name:t,url:this.getAvatarSrcUrl(t)}},e.userAvatarsData.get=function(){var t=[],a=Object.keys(this.caArgs.avatarsList),e=a.length;t.push(this.defaultAvatarData);for(var r=0;r<e;r++){var s=a[r];if(s!==u&&s!==A&&s!==d){var i={imgEl:null,name:s,url:this.getAvatarSrcUrl(s)};t.push(i)}}return t},e.defaultCommentAvatarTargetSrc.get=function(){return{avatarClassName:"comment_avatar",avatarImgClassName:"comment_avatar_img",avatarSelectButtonId:"commentAvatarSelectButton",emailInputId:"commentFormMail"}},e.defaultCommentAvatarOptions.get=function(){return{isUseLazysizes:!1,isUseAdminAvatar:!0,isUseSecretAvatar:!0,isCommentAvatarOverwrite:!0,isAvatarSelect:!0,isDebug:!1}},Object.defineProperties(a.prototype,e),t.CommentAvatar=a,t}({});
