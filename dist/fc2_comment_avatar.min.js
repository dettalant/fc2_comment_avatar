/*!
 * @file fc2_comment_avatar.js
 * See {@link https://github.com/dettalant/fc2_comment_avatar| dettalant/fc2_comment_avatar}
 *
 * @author dettalant
 * @version v0.2.0
 * @license MIT License
 */
var fc2_comment_avatar=function(a){"use strict";function s(a){this.message=a,this.name="NavManagerError"}var l=null===window.ontouchend?"touchend":"click",n="__default__",c="__admin__";s.prototype.toString=function(){return this.name+": "+this.message};function t(a){if(this.isUseDataSrc=!1,this.isUseCustomDefaultImg=!1,this.isUseAdminAvatar=!0,void 0===a)throw new s("初期化に必要な情報が入力されませんでした。CommentAvatarクラスの初期化引数には必要情報が格納されたobjectを入れてください");var t=document.getElementsByClassName(a.avatarClassName);if(0===t.length)throw new s("アバター要素の取得に失敗しました");var e=document.getElementById(a.avatarSelectButtonId);if(null===e)throw new s("アバター選択ボタン要素の取得に失敗しました");this.avatarContainers=t,this.avatarClassName=a.avatarClassName,this.avatarImgClassName=a.avatarImgClassName,this.avatarsList=this.avatarsListFormat(a.avatarsList),this.avatarSelectButton=e,this.avatarSelectButtonId=a.avatarSelectButtonId,a.isUseDataSrc&&(this.isUseDataSrc=a.isUseDataSrc),!1===a.isUseAdminAvatar&&(this.isUseAdminAvatar=a.isUseAdminAvatar),this.avatarSelectButtonImg=this.avatarSelectButtonInit(this.avatarSelectButton);var r=this.scanAvatarCodes();this.avatarsImgOverWrite(r)}var e={defaultAvatarData:{configurable:!0},userAvatarsData:{configurable:!0}};return t.prototype.avatarsListFormat=function(a){var t=n;return void 0===a[t]?a[t]="https://static.fc2.com/image/sh_design/no_image/no_image_300x300.png":this.isUseCustomDefaultImg=!0,void 0===a.__admin__&&(this.isUseAdminAvatar=!1),a},t.prototype.avatarSelectButtonInit=function(a){function n(a,t){a.addEventListener(l,function(a){return t(a)})}var v=this,t=[],e=document.createElement("img");e.className="comment_avatar_img lazyload";var r=this.defaultAvatarData;r.imgEl=e,this.avatarImgOverWrite(r);var s=document.createElement("div");s.className="comment_form_avatar_img_wrapper",s.appendChild(e),t.push(s);var i=a.dataset.buttonText;if(void 0!==i){var o=document.createElement("span");o.className="comment_form_avatar_button_text",o.innerText=i,t.push(o)}var m=document.createElement("div");return m.className="comment_form_avatar_select_container",function(s){for(var i=v.userAvatarsData,a=i.length,t=function(a){var t=i[a],e=document.createElement("button");e.type="button",e.className="comment_form_avatar_select_button",n(e,function(){console.log("click: "+t.name)});var r=document.createElement("img");r.className="comment_avatar_img lazyload",t.imgEl=r,v.avatarImgOverWrite(t),e.appendChild(t.imgEl),s.appendChild(e)},e=0;e<a;e++)t(e)}(m),t.push(m),function(a,t){for(var e=t.length,r=0;r<e;r++)a.appendChild(t[r])}(a,t),n(a,function(){m.classList.toggle("is_visible")}),e},t.prototype.avatarDataOverWrite=function(a,t,e,r){return t instanceof HTMLImageElement&&(a.imgEl=t),void 0!==e&&(a.name=e),void 0!==r&&(a.url=r),a},t.prototype.scanAvatarCodes=function(){for(var a=this.avatarContainers.length,t=[],e=0;e<a;e++){var r=this.avatarContainers[e],s=r.dataset.avatarCode,i=r.dataset.isAdminAvatar;if(this.isUseAdminAvatar&&i){var n=c,v=this.avatarDataOverWrite(this.defaultAvatarData,r.querySelector("."+this.avatarImgClassName),n,this.avatarsList[n]);t.push(v)}else if(void 0===s||-1===s.indexOf("[[")&&-1===s.indexOf("]]")){if(this.isUseCustomDefaultImg){var o=this.avatarDataOverWrite(this.defaultAvatarData,r.querySelector("."+this.avatarImgClassName));t.push(o)}}else{var m=/\[\[[\s　]*?([^\[\]\s　]+?)[\s　]*?\]\]/.exec(s);if(null!==m){var l=m[1];if(this.isMatchAvatarName(l)){var u=this.avatarDataOverWrite(this.defaultAvatarData,r.querySelector("."+this.avatarImgClassName),l,this.avatarsList[l]);t.push(u)}}}}return t},t.prototype.isMatchAvatarName=function(a){return!!this.avatarsList[a]},e.defaultAvatarData.get=function(){var a=n;return{imgEl:null,name:a,url:this.avatarsList[a]}},e.userAvatarsData.get=function(){var a=[],t=Object.keys(this.avatarsList),e=t.length;a.push(this.defaultAvatarData);for(var r=0;r<e;r++){var s=t[r];if(s!==n&&s!==c){var i=this.avatarDataOverWrite(this.defaultAvatarData,null,s,this.avatarsList[s]);a.push(i)}}return a},t.prototype.avatarImgOverWrite=function(a){null!==a.imgEl&&(this.isUseDataSrc?a.imgEl.dataset.src=a.url:a.imgEl.src=a.url)},t.prototype.avatarsImgOverWrite=function(a){for(var t=a.length,e=0;e<t;e++)this.avatarImgOverWrite(a[e])},Object.defineProperties(t.prototype,e),a.CommentAvatar=t,a}({});
