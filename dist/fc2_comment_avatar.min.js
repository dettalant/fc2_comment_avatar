/*!
 * @file fc2_comment_avatar.js
 * See {@link https://github.com/dettalant/fc2_comment_avatar| dettalant/fc2_comment_avatar}
 *
 * @author dettalant
 * @version v0.2.0
 * @license MIT License
 */
var fc2_comment_avatar=function(t){"use strict";function i(t){this.message=t,this.name="CommentAvatarError"}var c=null===window.ontouchend?"touchend":"click",h="__default__",u="__admin__",d="avatarCode",f="is_visible";i.prototype.toString=function(){return this.name+": "+this.message};function a(t){if(this.emailInputId="mail",this.isUseDataSrc=!1,this.isUseCustomDefaultImg=!1,this.isUseAdminAvatar=!0,void 0===t)throw new i("初期化に必要な情報が入力されませんでした。CommentAvatarクラスの初期化引数には必要情報が格納されたobjectを入れてください");var a=document.getElementsByClassName(t.avatarClassName);if(0===a.length)throw new i("アバター要素の取得に失敗しました");var e=document.getElementById(t.avatarSelectButtonId);if(null===e)throw new i("アバター選択ボタン要素の取得に失敗しました");var r=document.getElementById(t.emailInputId);if(null===r||!(r instanceof HTMLInputElement))throw new i("メールアドレス入力欄の取得に失敗しました");this.avatarContainers=a,this.avatarClassName=t.avatarClassName,this.avatarImgClassName=t.avatarImgClassName,this.avatarsList=this.avatarsListFormat(t.avatarsList),this.avatarSelectButton=e,this.avatarSelectButtonId=t.avatarSelectButtonId,this.emailInputId=t.emailInputId,this.emailInput=r,t.isUseDataSrc&&(this.isUseDataSrc=t.isUseDataSrc),!1===t.isUseAdminAvatar&&(this.isUseAdminAvatar=t.isUseAdminAvatar),this.avatarSelectButtonImg=this.avatarSelectButtonInit(this.avatarSelectButton);var s=this.scanAvatarCodes();this.avatarsImgOverWrite(s)}var e={defaultAvatarData:{configurable:!0},userAvatarsData:{configurable:!0}};return a.prototype.avatarsListFormat=function(t){return void 0===t[h]?t[h]="https://static.fc2.com/image/sh_design/no_image/no_image_300x300.png":this.isUseCustomDefaultImg=!0,void 0===t[u]&&(this.isUseAdminAvatar=!1),t},a.prototype.avatarSelectButtonInit=function(t){function n(t,a){t.addEventListener(c,function(t){return a(t)})}var o=this,a=[],e=document.createElement("img");e.className="comment_avatar_img lazyload";var r=this.defaultAvatarData,s=localStorage.getItem(d);if(null!==s&&""!==s){var i=this.avatarCodeParse(s);this.isMatchAvatarName(i)&&(this.emailInput.value=s,this.avatarDataOverWrite(r,e,i,this.getAvatarSrcUrl(i)))}r.imgEl=e,this.avatarImgOverWrite(r);var v=document.createElement("div");v.className="comment_form_avatar_img_wrapper",v.appendChild(e),a.push(v);var m=t.dataset.buttonText;if(void 0!==m){var l=document.createElement("span");l.className="comment_form_avatar_button_text",l.innerText=m,a.push(l)}var u=document.createElement("div");return u.className="comment_form_avatar_select_container",function(s){for(var i=o.userAvatarsData,t=i.length,a=function(t){var a=i[t],e=document.createElement("button");e.type="button",e.className="comment_form_avatar_select_button",n(e,function(){var t="";a.name!==h&&(t="[["+a.name+"]]"),o.emailInput.value=t,localStorage.setItem(d,t),o.avatarSelectButtonImg.src=a.url});var r=document.createElement("img");r.className="comment_avatar_img lazyload",a.imgEl=r,o.avatarImgOverWrite(a),e.appendChild(a.imgEl),s.appendChild(e)},e=0;e<t;e++)a(e)}(u),a.push(u),function(t,a){for(var e=a.length,r=0;r<e;r++)t.appendChild(a[r])}(t,a),n(t,function(){u.classList.toggle(f)}),document.addEventListener(c,function(t){if(-1!==u.className.indexOf(f)){var s=function(t,a){var e=t.tagName.toUpperCase(),r=a.toUpperCase();return e===r?t:e!==r&&null!==t.parentElement?s(t.parentElement,r):t};if(t.target instanceof Element){var a=s(t.target,"button");-1===a.className.indexOf("comment_form_avatar_select_button")&&-1===a.className.indexOf("comment_form_avatar_button")&&u.classList.remove(f)}}}),e},a.prototype.avatarDataOverWrite=function(t,a,e,r){return a instanceof HTMLImageElement&&(t.imgEl=a),void 0!==e&&(t.name=e),void 0!==r&&(t.url=r),t},a.prototype.scanAvatarCodes=function(){for(var t=this.avatarContainers.length,a=[],e=0;e<t;e++){var r=this.avatarContainers[e],s=r.dataset.avatarCode,i=r.dataset.isAdminAvatar;if(this.isUseAdminAvatar&&i){var n=u,o=this.avatarDataOverWrite(this.defaultAvatarData,r.querySelector("."+this.avatarImgClassName),n,this.getAvatarSrcUrl(n));a.push(o)}else if(void 0===s||-1===s.indexOf("[[")&&-1===s.indexOf("]]")){if(this.isUseCustomDefaultImg){var v=this.avatarDataOverWrite(this.defaultAvatarData,r.querySelector("."+this.avatarImgClassName));a.push(v)}}else{var m=this.avatarCodeParse(s);if(""!==m&&this.isMatchAvatarName(m)){var l=this.avatarDataOverWrite(this.defaultAvatarData,r.querySelector("."+this.avatarImgClassName),m,this.getAvatarSrcUrl(m));a.push(l)}}}return a},a.prototype.avatarCodeParse=function(t){var a=/\[\[[\s　]*?([^\[\]\s　]+?)[\s　]*?\]\]/.exec(t);return null===a||a.length<2?"":a[1]},a.prototype.isMatchAvatarName=function(t){return!!this.avatarsList[t]},e.defaultAvatarData.get=function(){var t=h;return{imgEl:null,name:t,url:this.getAvatarSrcUrl(t)}},e.userAvatarsData.get=function(){var t=[],a=Object.keys(this.avatarsList),e=a.length;t.push(this.defaultAvatarData);for(var r=0;r<e;r++){var s=a[r];if(s!==h&&s!==u){var i={imgEl:null,name:s,url:this.getAvatarSrcUrl(s)};t.push(i)}}return t},a.prototype.getAvatarSrcUrl=function(t){var a=this.avatarsList[t];return void 0===a?"":a},a.prototype.avatarImgOverWrite=function(t){null!==t.imgEl&&(this.isUseDataSrc?t.imgEl.dataset.src=t.url:t.imgEl.src=t.url)},a.prototype.avatarsImgOverWrite=function(t){for(var a=t.length,e=0;e<a;e++)this.avatarImgOverWrite(t[e])},Object.defineProperties(a.prototype,e),t.CommentAvatar=a,t}({});
